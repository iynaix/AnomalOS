#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if URL provided
if [[ $# -eq 0 ]]; then
    echo -e "${RED}Error: Please provide a YouTube/YouTube Music playlist URL${NC}"
    echo "Usage: scrapem <url>"
    echo "Example: scrapem 'https://music.youtube.com/playlist?list=PLAYLIST_ID'"
    exit 1
fi

PLAYLIST_URL="$1"
MUSIC_DIR="$HOME/Music"

echo -e "${BLUE}Fetching playlist information...${NC}"

# Try to extract playlist title with a timeout
PLAYLIST_NAME=$(timeout 15 nix run nixpkgs#yt-dlp -- --flat-playlist --print "%(playlist_title)s" "$PLAYLIST_URL" 2>/dev/null | head -1 || echo "")

# Fallback: if extraction fails or times out, ask user
if [[ -z "$PLAYLIST_NAME" ]]; then
    echo -e "${YELLOW}Could not automatically fetch playlist name.${NC}"
    read -p "Please enter a name for this playlist: " PLAYLIST_NAME

    if [[ -z "$PLAYLIST_NAME" ]]; then
        echo -e "${RED}Error: Playlist name cannot be empty${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}Playlist name: $PLAYLIST_NAME${NC}"

# Create directory
if [[ -d "$MUSIC_DIR/$PLAYLIST_NAME" ]]; then
    echo -e "${RED}Directory already exists: $MUSIC_DIR/$PLAYLIST_NAME${NC}"
    read -p "Overwrite? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
else
    mkdir -p "$MUSIC_DIR/$PLAYLIST_NAME"
fi

cd "$MUSIC_DIR/$PLAYLIST_NAME"

echo -e "${BLUE}Downloading playlist...${NC}"

# Download all tracks as MP3s
nix run nixpkgs#yt-dlp -- -x --audio-format mp3 "$PLAYLIST_URL"

echo -e "${GREEN}Download complete!${NC}"
echo -e "${BLUE}Creating playlist file...${NC}"

# Create VLC playlist sorted by creation time
{
    echo "#EXTM3U"
    ls -1tr *.mp3 2>/dev/null | while read -r file; do
        # Extract title by removing the video ID in brackets
        title="${file%.mp3}"
        title="${title% \[*\]}"
        echo "#EXTINF:-1,$title"
        echo "$file"
    done
} > "${PLAYLIST_NAME}.m3u8"

echo -e "${GREEN}Playlist file created: ${PLAYLIST_NAME}.m3u8${NC}"
echo -e "${GREEN}All done! Playlist saved to: $MUSIC_DIR/$PLAYLIST_NAME/${NC}"
